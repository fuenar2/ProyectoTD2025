---
title: " Mini Proyecto 2025. Análisis de tickets de supermercado"
author: "Mar Fuentes Armenteros, Paula Girbés Plaza, Pablo Fernando Navarro Sánchez, Andreu Serrano Briz, Hugo Cuñat Alabau y Rafael Cebrián Pérez"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    df_print: kable
  bookdown::html_document2:
    fig_caption: yes
    df_print: kable
 
 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Carga-librerias, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE) 
library(pdftools)
library(stringr)
library(dplyr)
library(lubridate)
library(knitr)
library(bookdown)
library(kableExtra)

options(OutDec = ",", digits = 2)

```

```{r Exportacion-tickets, include=FALSE}

carpeta_data <- "data"

# Obtenemos todos los nombres de los tickets que tengan extensión pdf y los guardamos en una lista
tickets <- list.files(carpeta_data, pattern = "\\.pdf$", full.names = TRUE)


```

```{r Procesamiento-ticket, include=FALSE}

#Esta función procesa un ticket
procesar_ticket <- function(ticket){
  # Extraemos toda la información del ticket como un vector
  texto <- pdf_text(ticket)
  texto <- paste(texto, collapse = "\n") # unimos todo el texto en un solo string
  
  #Verificación de que es un ticket de Mercadona
  if (!str_detect(texto, "MERCADONA, S\\.A\\.")) {
    return(NULL)  
  }
  supermercado <- "MERCADONA"
  
  # Obtenemos las líneas de texto individuales 
  lineas <- str_split(texto, "\n")[[1]]%>% 
    str_trim() %>% 
    .[. != ""]
  
  # Dirección (línea que contenga "CTRA.")
  idx_mercadona <- grep("MERCADONA, S\\.A\\.", lineas)
  direccion <- if (length(idx_mercadona) > 0 && idx_mercadona + 1 <= length(lineas)) {
    str_trim(lineas[idx_mercadona + 1])
  } else {
    NA
  }
  
  # Código postal
  linea_cp_municipio <- lineas[grepl("^\\s*\\d{5}\\s+\\w+", lineas)][1]
  codigo_postal <- ifelse(!is.na(linea_cp_municipio), str_extract(linea_cp_municipio, "\\d{5}"), NA)
  
  #Municipio
  municipio <- ifelse(!is.na(linea_cp_municipio), str_trim(str_remove(linea_cp_municipio, "^\\s*\\d{5}\\s+")), NA)
  
  # Teléfono
  telefono <- str_extract(texto, "TELÉFONO: \\d+")
  telefono <- ifelse(!is.na(telefono), str_remove(telefono, "TELÉFONO: "), NA)
  
  # Fecha 
  fecha <- str_extract(texto, "\\d{2}/\\d{2}/\\d{4}")
  
  #Hora
  hora <- str_extract(texto, "(?<=\\d{2}/\\d{2}/\\d{4} )\\d{2}:\\d{2}")
  
  # Número de operador
  op <- str_extract(texto, "OP: \\d+")
  op <- ifelse(!is.na(op), str_remove(op, "OP: "), NA)
  
  # Número de tienda, caja y factura
  factura <- str_extract(texto, "FACTURA SIMPLIFICADA: \\d+-\\d+-\\d+")
  if (!is.na(factura)) {
    partes <- unlist(str_split(str_remove(factura, "FACTURA SIMPLIFICADA: "), "-"))
    tienda <- partes[1]
    caja <- partes[2]
    num_factura <- partes[3]
  } else {
    tienda <- NA
    caja <- NA
    num_factura <- NA
  }
  
  # Parking
  entrada <- str_extract(texto, "ENTRADA\\s+\\d{2}:\\d{2}") %>% str_extract("\\d{2}:\\d{2}")
  salida <- str_extract(texto, "SALIDA\\s+\\d{2}:\\d{2}") %>% str_extract("\\d{2}:\\d{2}")
  
  # Total
  total <- str_match(texto, "TOTAL \\(€\\)\\s+(\\d+,\\d{2})")[,2] %>% str_replace(",", ".") %>% as.numeric()
  
  #Tarjeta
  tarjeta <- str_extract(texto, "TARJ\\. BANCARIA.*?(\\d{4})")
  tarjeta <- ifelse(!is.na(tarjeta), str_extract(tarjeta, "\\d{4}"), NA)
  
  #Nc
  nc <- str_extract(texto, "N\\.C: \\d+")
  nc <- ifelse(!is.na(nc), str_remove(nc, "N\\.C: "), NA)
  
  #Aut
  aut <- str_extract(texto, "AUT: \\d+")
  aut <- ifelse(!is.na(aut), str_remove(aut, "AUT: "), NA)
  
  #Aid
  aid <- str_extract(texto, "AID: [\\w\\d]+")
  aid <- ifelse(!is.na(aid), str_remove(aid, "AID: "), NA)
  
  #Arc
  arc <- str_extract(texto, "ARC: \\d+")
  arc <- ifelse(!is.na(arc), str_remove(arc, "ARC: "), NA)
  
  #Tipo de pago
  tipo_pago <- str_match(texto, "(VISA|MASTERCARD|AMEX|DÉBITO|CRÉDITO|DEBITO|CREDITO|EFECTIVO)[ /A-Z]*")[,1]
  
  # Productos
  productos <- list()
  en_pescado <- FALSE
  
   for (i in seq_along(lineas)) {
    linea <- lineas[i]
    if (str_detect(linea, "^PESCADO$")) {
      en_pescado <- TRUE
      next
    }
    
    if (i < length(lineas)) {
      linea_siguiente <- lineas[i + 1]

      # Detectar formato de producto con peso
      if (str_detect(linea_siguiente, "\\d+[.,]\\d+\\s*kg\\s+\\d+[.,]\\d+\\s*€/kg")) {
        nombre <- linea
        datos <- str_match(linea_siguiente, "(\\d+[.,]\\d+)\\s*kg\\s+(\\d+[.,]\\d+)\\s*€/kg\\s+(\\d+[.,]\\d{2})")
        peso <- as.numeric(str_replace(datos[2], ",", "."))
        precio_kg <- as.numeric(str_replace(datos[3], ",", "."))
        importe <- as.numeric(str_replace(datos[4], ",", "."))

        categoria <- if (en_pescado) "pescado" else if (str_detect(tolower(nombre), "kiwi|banana|mandarina|tomate|espinaca|ajo|champiñon")) "fruta/verdura" else "venta_por_unidades"

        productos[[length(productos) + 1]] <- data.frame(
          producto = nombre, cantidad = peso,
          precio_unitario = precio_kg, importe = importe,
          es_peso = TRUE, categoria = categoria, stringsAsFactors = FALSE
        )
        next
      }
    }
    partes <- str_match(linea, "^(\\d+)\\s+(.*?)\\s+(\\d+[.,]\\d{2})(?:\\s+(\\d+[.,]\\d{2}))?$")
    if (!all(is.na(partes))) {
      cantidad <- as.numeric(partes[2])
      producto <- partes[3]
      precio_unit <- as.numeric(str_replace(partes[4], ",", "."))
      importe <- ifelse(!is.na(partes[5]), as.numeric(str_replace(partes[5], ",", ".")), precio_unit * cantidad)

      categoria <- if (en_pescado) "pescado" else "venta_por_unidades"
      

      productos[[length(productos) + 1]] <- data.frame(
        producto = producto, cantidad = cantidad,
        precio_unitario = precio_unit, importe = importe,
        es_peso = FALSE, categoria = categoria, stringsAsFactors = FALSE
      )
    }
  }

  if (length(productos) == 0) return(NULL)

  df_productos <- do.call(rbind, productos) %>%
    mutate(
      ticket_id = factura, supermercado = supermercado, direccion = direccion,
      codigo_postal = codigo_postal, municipio = municipio, telefono = telefono,
      fecha = fecha, hora = hora, op = op, tienda = tienda, caja = caja, num_factura = num_factura,
      entrada = entrada, salida = salida, total = total, tarjeta = tarjeta,
      nc = nc, aut = aut, aid = aid, arc = arc, tipo_pago = tipo_pago
    )
  df_productos <- df_productos %>%
  mutate(
    categoria = ifelse(str_detect(producto, "^1\\s+"), "fruta/verdura", categoria),
    producto = str_replace(producto, "^1\\s+", ""),
    cantidad = ifelse(es_peso, round(importe / precio_unitario, 1), cantidad),
    categoria = as.factor(categoria)
  )

  return(df_productos)
}


# Procesamiento con filtrado
lista_tickets <- lapply(tickets, procesar_ticket)
lista_tickets <- lista_tickets[!sapply(lista_tickets, is.null)] 

# Combina y elimina duplicados 
tickets_df <- do.call(rbind, lista_tickets)
tickets_df <- tickets_df[!duplicated(tickets_df[, c("ticket_id", "producto", "cantidad", "precio_unitario")]), ]

# Cambiar los tipos de datos
if (!is.null(tickets_df)) {
  tickets_df <- tickets_df %>%
    mutate(
      cantidad = as.integer(cantidad),
      codigo_postal = as.integer(codigo_postal),
      telefono = as.integer(telefono),
      op = as.integer(op),
      tienda = as.integer(tienda),
      caja = as.integer(caja),
      num_factura = as.integer(num_factura),
      tarjeta = as.integer(tarjeta),
      nc = as.integer(nc),
      aut = as.integer(aut),
      arc = as.integer(arc),
      fecha = dmy(fecha),
      hora = format(as.POSIXct(hora, format = "%H:%M"), "%H:%M"),  
      entrada = format(as.POSIXct(entrada, format = "%H:%M"), "%H:%M"),  
      salida = format(as.POSIXct(salida, format = "%H:%M"), "%H:%M")    
    )%>%mutate(
    cantidad = ifelse(es_peso, round(importe / precio_unitario,1), cantidad)
  )
}
#

```


# Introducción
En este proyecto se aborda el análisis exploratorio de
datos a partir de tickets de supermercado, con el objetivo de extraer
información relevante sobre los hábitos de consumo, productos
adquiridos, precios y comportamiento de compra. El conjunto de datos que se utiliza pertenece a varios tickets del supermercado Mercadona proporcionados por la Universidad de Valencia (UV). En concreto, pertenece a una recolecta entre el profesor y varios alumnos de la asignatura de Tratamiento de datos.
Este proyecto tiene como objetivo analizar los datos extraidos de los tickets para responder a las siguientes preguntas:

¿Cuáles son los 5 productos, de los vendidos por unidades, con más ventas ? ¿Cuántas unidades de cada uno se han vendido ?

Si consideramos la categoría de FRUTAS Y VERDURAS. Cuáles son los 5 productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos ?

Si consideramos la categoría de PESCADO. Cuáles son los 5 productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos ?

Muestra mediante un gráfico de líneas como ha variado el precio por kilo de las bananas y los plátanos en los tickets disponibles, a lo largo del tiempo.

¿ Cuál es la procedencia de los tickets ?¿ Qué ciudad/ pueblo tiene un mayor número de tickets ?

```{r}
library(dplyr)
library(ggplot2)

tickets_por_municipio <- tickets_df %>%
  distinct(ticket_id, municipio) %>% #Asegura que cada ticket cuente una vex por municipio
  count(municipio, sort = TRUE) #Agrupa por municipio y cuenta registros y ordena de manera desdendente

head(tickets_por_municipio, 10) #Muestra los 10 primeros municipios

tickets_por_municipio %>%
  slice_max(n, n = 10) %>% #Selecciona los 10 municipios con mayor numero de tickets
  ggplot(aes(x = reorder(municipio, n), y = n))  + #Ordena municipios por el valor de n (es decir, 10)
  geom_bar(stat = "identity", fill = "steelblue") + #Creagrafico de barras
  coord_flip() #Invierte el grafico para que se vea horizontal
  labs(
    title = "Top 10 municipios con más tickets",
    x = "Municipio",
    y = "Número de tickets"
  ) +
  theme_minimal()

#Los tickets provienen de Valencia, y de pueblos de alrededor

#La ciudad con mayor numero tickets es Valencia
```
Los tickets provienen de Valencia y de pueblos de alrededor. Y la ciudad con mayor número de tickets es Valencia.



Muestra mediante un diagrama el número de tickets recogidos cada día de las semana. ¿Si tuvieses que cerrar un día entre semana qué día lo harías ?

```{r}
library(dplyr) 
library(ggplot2)
library(lubridate)

# Asegurarse de que la columna fecha es tipo Date
tickets_df <- tickets_df %>%
  mutate(fecha = as.Date(fecha)) #convertir en tipo fecha (si no lo era)

# Obtener día de la semana por ticket
tickets_dia_semana <- tickets_df %>%
  distinct(ticket_id, fecha) %>% #eliminar duplicados
  mutate(dia_semana = wday(fecha, label = TRUE, abbr = FALSE)) %>% #extraer dia de la semana con wday y con label usar nombres de los dias de la semana.
  count(dia_semana)

ggplot(tickets_dia_semana, aes(x = reorder(dia_semana, n), y = n)) + #Ordenar los dias de la semana por frecuencia de tickets
  geom_bar(stat = "identity", fill = "pink") +#crear grafico de barras vertical
  labs(title = "Número de tickets por día de la semana", x = "Día", y = "Número de tickets") + 
  coord_flip() + #invertir el grafico em horizontal
  theme_minimal() 

#Como el domingo está cerrado, el que menos ventas tiene es el Jueves.


```
En el ejercicio del diagrama del número de tickets por día, se puede observar que el dia que menos ventas hay y por lo cual sería el dia que cerraría, seria el jueves, aunque en el diagrama salga el domingo, pero ese dia siempre está cerrado el Mercadona




1.¿Cuáles son las frutas más compradas durante la
primavera? (Filtrar por fecha y categoría de producto).

2.¿Qué productos suelen comprarse más durante festivos como Navidad,
Semana Santa o Fallas? (Comparar ventas en fechas clave con el resto del
año).

```{r}
library(dplyr)

tickets_df <- tickets_df %>%
  mutate(fecha = as.Date(fecha))

top_navidad <- tickets_df %>%
  filter(
    (fecha >= as.Date("2023-12-20") & fecha <= as.Date("2023-12-31")) |  # Navidad 2023
    (fecha >= as.Date("2024-12-20") & fecha <= as.Date("2024-12-31"))     # Navidad 2024
  ) %>%
  group_by(producto) %>%
  summarise(unidades = sum(cantidad), .groups = "drop") %>%
  arrange(desc(unidades)) %>%
  slice_head(n = 3)

top_semana_santa <- tickets_df %>%
  filter(
    fecha >= as.Date("2024-03-23") & fecha <= as.Date("2024-03-30")  # Semana Santa 2024
  ) %>%
  group_by(producto) %>%
  summarise(unidades = sum(cantidad), .groups = "drop") %>%
  arrange(desc(unidades)) %>%
  slice_head(n = 3)

top_fallas <- tickets_df %>%
  filter(
    (fecha >= as.Date("2024-03-15") & fecha <= as.Date("2024-03-19")) |  # Fallas 2024
    (fecha >= as.Date("2025-03-15") & fecha <= as.Date("2025-03-15"))    # Único día disponible en 2025
  ) %>%
  group_by(producto) %>%
  summarise(unidades = sum(cantidad), .groups = "drop") %>%
  arrange(desc(unidades)) %>%
  slice_head(n = 3)

list("Navidad" = top_navidad %>% mutate(festivo = "Navidad"),      
  "Semana Santa" = top_semana_santa %>% mutate(festivo = "Semana Santa"),
  "Fallas" = top_fallas %>% mutate(festivo = "Fallas")
) %>%
  bind_rows() %>%               
  select(festivo, producto, unidades) %>%  
  arrange(festivo, desc(unidades)) 
```
Los productos que mas se suelen vender en Fallas son: Harina Integral, Habas y Azúcar. Mientras que en Navidad es: Cola sin cafeína, Yogur coco y Agua Cortes. Y por último en Semana Santa: Chapata Cristal, Tinto Bobal y Arroz.




3.¿Se compran productos diferentes en zonas urbanas frente a rurales?
(Agrupar por ciudad o código postal y comparar top productos).

4.¿Qué productos suelen comprarse juntos con frecuencia? (por ejemplo,
pan con chocolate) (Analizar combinaciones frecuentes dentro del mismo
ticket).

5.¿Qué productos se mantienen en la cesta aunque cambien de precio?
(Observar si bajadas o subidas de precio afectan a las unidades
compradas).

6.¿Cuántos productos se compran en promedio por ticket? (Contar
productos por ticket y calcular la media).

7.¿Qué categorías suelen comprarse en conjunto? (Ej. frutas + lácteos)
(Clasificar productos por categoría y ver combinaciones más frecuentes).

8.¿Cómo cambia el gasto promedio según el día de la semana? (Comparar el
total gastado y cantidad de tickets por día).

9.¿Qué día tiene menos volumen de compras? ¿Y cuál el mayor? (Contar
número de tickets por día de la semana).

10¿Qué mes registra mayores compras de frutas y verduras? (Filtrar por
categoría y agrupar por mes).

11. ¿Qué productos tienen mayor rotación semanal y cuáles permanecen más
    tiempo sin comprarse? (Agrupar ventas por semana y producto,
    analizar frecuencia de compra).

12. ¿Cómo afecta la climatología al tipo de productos comprados? (ej.
    helados en verano, sopas en invierno) (Relacionar fechas con
    estaciones y tipos de producto).

13. ¿Qué impacto tienen las promociones o descuentos en la cantidad
    comprada de un producto? (Comparar unidades vendidas antes, durante
    y después de una promoción).

14. ¿Qué ticket promedio se observa según el tipo de establecimiento
    (urbano, rural, turístico)? (Agrupar por zona y calcular gasto
    promedio por ticket).

15. ¿Qué productos suelen ser los primeros en desaparecer en compras
    grandes (+20 productos)? (Analizar orden de productos en tickets
    extensos).

16. ¿Existen diferencias de compra entre clientes que compran entre
    semana frente a fines de semana? (Comparar volumen y tipo de
    productos por día).

17. ¿Hay patrones de consumo distintos entre zonas costeras y zonas del
    interior? (Comparar categorías más compradas según localización
    geográfica).

18. ¿Qué marcas blancas se compran más en comparación con productos de
    marca? (Clasificar productos por tipo de marca y analizar
    proporciones de compra).

19. ¿Cuáles son los productos más comprados por la mañana frente a la
    tarde? (Agrupar tickets por franja horaria y analizar top
    productos).

```{r}
library(dplyr)
library(readr)
library(knitr)

mañana_tarde <- tickets_df %>%
  mutate(
    hora_numeric = as.numeric(substr(hora, 1, 2)),  # Extraer hora
    franja = case_when(
      hora_numeric >= 8 & hora_numeric < 14 ~ "Mañana",
      hora_numeric >= 14 & hora_numeric < 20 ~ "Tarde",
      TRUE ~ "Otro"
    )
  ) %>%
  filter(franja != "Otro")  

top_productos <- tickets_df %>%
  group_by(franja, producto) %>%
  summarise(cantidad_total = sum(cantidad, na.rm = TRUE), .groups = "drop") %>%
  group_by(franja) %>%
  slice_max(order_by = cantidad_total, n = 5)  # Top 5 por franja

kable(
  top_productos,
  caption = "Top 5 productos por franja horaria",
  col.names = c("Franja", "Producto", "Cantidad Total")
)


```
Los productos que mas se venden por la mañana son: Espárragos verde fino, Atún claro oliva, Queso lonchas cabra, Tomate triturado y Sandía baja semillas. Mientras que por la tarde: Atún claro olivam Plátano, Yogur coco, Bolsa de plástico y Leche Desnatada



20. ¿Qué artículos aumentan su venta a fin de mes (posiblemente por
    cobro de sueldos)? (Comparar ventas por semana del mes,
    especialmente última semana)

# Material y Métodos

## *Carga de librerías y datos necesarios para el análisis*

```{r tabla-librerias}
librerias <- data.frame(
  "Librería" = c("pdftools", "stringr", "dplyr", "lubridate", 
                "knitr", "bookdown", "kableExtra", "purrr", "tidyr"),
  "Función" = c(
    "Extraer texto de archivos PDF",
    "Manipulación de cadenas con regex",
    "Transformación y manipulación de datos",
    "Manejo avanzado de fechas/horas",
    "Generación de informes dinámicos",
    "Creación de documentos académicos",
    "Formato profesional de tablas",
    "Iteraciones y programación funcional",
    "Organización de datos en formato tidy"
  )
)

knitr::kable(
  librerias,
  caption = "Librerías utilizadas y su función",
  booktabs = TRUE
)
```


Para el correcto desarrollo de la exportación y análisis de los datos, en primer lugar, se cargan todas las librerías necesarias al principio del código. Estas librerías son las mostradas en la Tabla \ref{tab:tabla-librerias}.

Posteriormente, se realiza la carga de los tickets. Estos tickets se encuentran

## *Características de los datos*

### *Análisis de missing data en nuestro conjunto de interés*

### *Variables de tipo numérico*

### *Variables de tipo categórico*

### *Análisis de los outliers*



# Resultados

# Conclusiones
