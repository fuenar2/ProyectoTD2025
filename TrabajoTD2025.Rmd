---
title: "TrabajoTD2025"
author: "Mar Fuentes Armenteros, Paula Girbés Plaza, Pablo Fernando Navarro Sánchez, Andrés Serrano Briz, Hugo Cuñat Alabau y Rafael Cebrián Pérez"
date: "2025-05-10"
output: html_document
css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Carga-librerias, include=FALSE}

library(pdftools)
library(stringr)
library(dplyr)
library(lubridate)
library(knitr)
library(bookdown)
library(kableExtra)

```

```{r Exportacion-tickets, include=FALSE}

carpeta_data <- "data"

# Obtenemos todos los nombres de los tickets que tengan extensión pdf y los guardamos en una lista
tickets <- list.files(carpeta_data, pattern = "\\.pdf$", full.names = TRUE)


```

```{r Procesamiento-ticket, include=FALSE}

#Esta función procesa un ticket
procesar_ticket <- function(ticket){
  # Extraemos toda la información del ticket como un vector
  texto <- pdf_text(ticket)
  texto <- paste(texto, collapse = "\n") # unimos todo el texto en un solo string
  
  supermercado <- "MERCADONA"
  
  # Obtenemos las líneas de texto individuales 
  lineas <- str_split(texto, "\n")[[1]]
  
  # Dirección (línea que contenga "CTRA.")
  idx_mercadona <- grep("MERCADONA, S\\.A\\.", lineas)
  direccion <- if (length(idx_mercadona) > 0 && idx_mercadona + 1 <= length(lineas)) {
    str_trim(lineas[idx_mercadona + 1])
  } else {
    NA
  }
  
  # Código postal
  linea_cp_municipio <- lineas[grepl("^\\s*\\d{5}\\s+\\w+", lineas)][1]
  codigo_postal <- ifelse(!is.na(linea_cp_municipio), str_extract(linea_cp_municipio, "\\d{5}"), NA)
  
  #Municipio
  municipio <- ifelse(!is.na(linea_cp_municipio), str_trim(str_remove(linea_cp_municipio, "^\\s*\\d{5}\\s+")), NA)
  
  # Teléfono
  telefono <- str_extract(texto, "TELÉFONO: \\d+")
  telefono <- ifelse(!is.na(telefono), str_remove(telefono, "TELÉFONO: "), NA)



}
```

