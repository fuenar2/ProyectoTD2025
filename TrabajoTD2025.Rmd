---
title: "TrabajoTD2025"
author: "Mar Fuentes Armenteros, Paula Girbés Plaza, Pablo Fernando Navarro Sánchez, Andrés Serrano Briz, Hugo Cuñat Alabau y Rafael Cebrián Pérez"
date: "2025-05-10"
output: html_document
css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Carga-librerias, include=FALSE}

library(pdftools)
library(stringr)
library(dplyr)
library(lubridate)
library(knitr)
library(bookdown)
library(kableExtra)

```

```{r Exportacion-tickets, include=FALSE}

carpeta_data <- "data"

# Obtenemos todos los nombres de los tickets que tengan extensión pdf y los guardamos en una lista
tickets <- list.files(carpeta_data, pattern = "\\.pdf$", full.names = TRUE)


```

```{r Procesamiento-ticket, include=FALSE}

#Esta función procesa un ticket
procesar_ticket <- function(ticket){
  # Extraemos toda la información del ticket como un vector
  texto <- pdf_text(ticket)
  texto <- paste(texto, collapse = "\n") # unimos todo el texto en un solo string
  
  supermercado <- "MERCADONA"
  
  # Obtenemos las líneas de texto individuales 
  lineas <- str_split(texto, "\n")[[1]]
  
  # Dirección (línea que contenga "CTRA.")
  idx_mercadona <- grep("MERCADONA, S\\.A\\.", lineas)
  direccion <- if (length(idx_mercadona) > 0 && idx_mercadona + 1 <= length(lineas)) {
    str_trim(lineas[idx_mercadona + 1])
  } else {
    NA
  }
  
  # Código postal
  linea_cp_municipio <- lineas[grepl("^\\s*\\d{5}\\s+\\w+", lineas)][1]
  codigo_postal <- ifelse(!is.na(linea_cp_municipio), str_extract(linea_cp_municipio, "\\d{5}"), NA)
  
  #Municipio
  municipio <- ifelse(!is.na(linea_cp_municipio), str_trim(str_remove(linea_cp_municipio, "^\\s*\\d{5}\\s+")), NA)
  
  # Teléfono
  telefono <- str_extract(texto, "TELÉFONO: \\d+")
  telefono <- ifelse(!is.na(telefono), str_remove(telefono, "TELÉFONO: "), NA)
  
  # Fecha 
  fecha <- str_extract(texto, "\\d{2}/\\d{2}/\\d{4}")
  
  #Hora
  hora <- str_extract(texto, "(?<=\\d{2}/\\d{2}/\\d{4} )\\d{2}:\\d{2}")
  
  # Número de operador
  op <- str_extract(texto, "OP: \\d+")
  op <- ifelse(!is.na(op), str_remove(op, "OP: "), NA)
  
  # Número de tienda, caja y factura
  factura <- str_extract(texto, "FACTURA SIMPLIFICADA: \\d+-\\d+-\\d+")
  if (!is.na(factura)) {
    partes <- unlist(str_split(str_remove(factura, "FACTURA SIMPLIFICADA: "), "-"))
    tienda <- partes[1]
    caja <- partes[2]
    num_factura <- partes[3]
  } else {
    tienda <- NA
    caja <- NA
    num_factura <- NA
  }
  
  # Parking
  entrada <- str_extract(texto, "ENTRADA\\s+\\d{2}:\\d{2}")
  entrada <- ifelse(is.na(entrada), NA, str_extract(entrada, "\\d{2}:\\d{2}"))
  salida <- str_extract(texto, "SALIDA\\s+\\d{2}:\\d{2}")
  salida <- ifelse(is.na(salida), NA, str_extract(salida, "\\d{2}:\\d{2}"))
  
  # Total
  total <- str_match(texto, "TOTAL \\(€\\)\\s+(\\d+,\\d{2})")[,2]
  total <- ifelse(!is.na(total), as.numeric(str_replace(total, ",", ".")), NA)
  
  #Tarjeta
  tarjeta <- str_extract(texto, "TARJ\\. BANCARIA.*?(\\d{4})")
  tarjeta <- ifelse(!is.na(tarjeta), str_extract(tarjeta, "\\d{4}"), NA)
  
  nc <- str_extract(texto, "N\\.C: \\d+")
  nc <- ifelse(!is.na(nc), str_remove(nc, "N\\.C: "), NA)
  
  aut <- str_extract(texto, "AUT: \\d+")
  aut <- ifelse(!is.na(aut), str_remove(aut, "AUT: "), NA)
  
  aid <- str_extract(texto, "AID: [\\w\\d]+")
  aid <- ifelse(!is.na(aid), str_remove(aid, "AID: "), NA)










}
```

