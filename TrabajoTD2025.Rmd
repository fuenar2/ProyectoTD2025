---
title: "TrabajoTD2025"
author: "Mar Fuentes Armenteros, Paula Girbés Plaza, Pablo Fernando Navarro Sánchez, Andrés Serrano Briz, Hugo Cuñat Alabau y Rafael Cebrián Pérez"
date: "2025-05-10"
output: html_document
css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Carga-librerias, include=FALSE}

library(pdftools)
library(stringr)
library(dplyr)
library(lubridate)
library(knitr)
library(bookdown)
library(kableExtra)

```

```{r Exportacion-tickets, include=FALSE}

carpeta_data <- "data"

# Obtenemos todos los nombres de los tickets que tengan extensión pdf y los guardamos en una lista
tickets <- list.files(carpeta_data, pattern = "\\.pdf$", full.names = TRUE)


```

```{r Procesamiento-ticket, include=FALSE}

#Esta función procesa un ticket
procesar_ticket <- function(ticket){
  # Extraemos toda la información del ticket como un vector
  texto <- pdf_text(ticket)
  texto <- paste(texto, collapse = "\n") # unimos todo el texto en un solo string
  
  supermercado <- "MERCADONA"
  
  # Obtenemos las líneas de texto individuales 
  lineas <- str_split(texto, "\n")[[1]]
  
  # Dirección (línea que contenga "CTRA.")
  idx_mercadona <- grep("MERCADONA, S\\.A\\.", lineas)
  direccion <- if (length(idx_mercadona) > 0 && idx_mercadona + 1 <= length(lineas)) {
    str_trim(lineas[idx_mercadona + 1])
  } else {
    NA
  }
  
  # Código postal
  linea_cp_municipio <- lineas[grepl("^\\s*\\d{5}\\s+\\w+", lineas)][1]
  codigo_postal <- ifelse(!is.na(linea_cp_municipio), str_extract(linea_cp_municipio, "\\d{5}"), NA)
  
  #Municipio
  municipio <- ifelse(!is.na(linea_cp_municipio), str_trim(str_remove(linea_cp_municipio, "^\\s*\\d{5}\\s+")), NA)
  
  # Teléfono
  telefono <- str_extract(texto, "TELÉFONO: \\d+")
  telefono <- ifelse(!is.na(telefono), str_remove(telefono, "TELÉFONO: "), NA)
  
  # Fecha 
  fecha <- str_extract(texto, "\\d{2}/\\d{2}/\\d{4}")
  
  #Hora
  hora <- str_extract(texto, "(?<=\\d{2}/\\d{2}/\\d{4} )\\d{2}:\\d{2}")
  
  # Número de operador
  op <- str_extract(texto, "OP: \\d+")
  op <- ifelse(!is.na(op), str_remove(op, "OP: "), NA)
  
  # Número de tienda, caja y factura
  factura <- str_extract(texto, "FACTURA SIMPLIFICADA: \\d+-\\d+-\\d+")
  if (!is.na(factura)) {
    partes <- unlist(str_split(str_remove(factura, "FACTURA SIMPLIFICADA: "), "-"))
    tienda <- partes[1]
    caja <- partes[2]
    num_factura <- partes[3]
  } else {
    tienda <- NA
    caja <- NA
    num_factura <- NA
  }
  
  # Parking
  entrada <- str_extract(texto, "ENTRADA\\s+\\d{2}:\\d{2}")
  entrada <- ifelse(is.na(entrada), NA, str_extract(entrada, "\\d{2}:\\d{2}"))
  salida <- str_extract(texto, "SALIDA\\s+\\d{2}:\\d{2}")
  salida <- ifelse(is.na(salida), NA, str_extract(salida, "\\d{2}:\\d{2}"))
  
  # Total
  total <- str_match(texto, "TOTAL \\(€\\)\\s+(\\d+,\\d{2})")[,2]
  total <- ifelse(!is.na(total), as.numeric(str_replace(total, ",", ".")), NA)
  
  #Tarjeta
  tarjeta <- str_extract(texto, "TARJ\\. BANCARIA.*?(\\d{4})")
  tarjeta <- ifelse(!is.na(tarjeta), str_extract(tarjeta, "\\d{4}"), NA)
  
  #Nc
  nc <- str_extract(texto, "N\\.C: \\d+")
  nc <- ifelse(!is.na(nc), str_remove(nc, "N\\.C: "), NA)
  
  #Aut
  aut <- str_extract(texto, "AUT: \\d+")
  aut <- ifelse(!is.na(aut), str_remove(aut, "AUT: "), NA)
  
  #Aid
  aid <- str_extract(texto, "AID: [\\w\\d]+")
  aid <- ifelse(!is.na(aid), str_remove(aid, "AID: "), NA)
  
  #Arc
  arc <- str_extract(texto, "ARC: \\d+")
  arc <- ifelse(!is.na(arc), str_remove(arc, "ARC: "), NA)
  
  #Tipo de pago
  tipo_pago <- str_match(texto, "(VISA|MASTERCARD|AMEX|DÉBITO|CRÉDITO|DEBITO|CREDITO|EFECTIVO)[ /A-Z]*")[,1]
  
  # Productos
  idx_productos <- grep("^\\d+\\s+.*\\d+,\\d{2}$", lineas)
  
  if (length(idx_productos) > 0) {
    productos <- lapply(lineas[idx_productos], function(linea) {
      partes <- str_match(linea, "^(\\d+)\\s+(.*?)\\s+(\\d+,\\d{2})(?:\\s+(\\d+,\\d{2}))?$")
      cantidad <- as.numeric(partes[2])
      producto <- str_trim(partes[3])
      precio_unit <- ifelse(is.na(partes[4]), partes[5], partes[4])
      precio_unit <- as.numeric(str_replace(precio_unit, ",", "."))
      importe <- ifelse(!is.na(partes[5]), as.numeric(str_replace(partes[5], ",", ".")), precio_unit * cantidad)
      
      data.frame(
        producto = producto,
        cantidad = cantidad,
        precio_unitario = precio_unit,
        importe = importe,
        supermercado = supermercado,
        direccion = direccion,
        codigo_postal = codigo_postal,
        municipio = municipio,
        telefono = telefono,
        fecha = fecha,
        hora = hora,
        op = op,
        tienda = tienda,
        caja = caja,
        num_factura = num_factura,
        entrada = entrada,
        salida = salida,
        total = total,
        tarjeta = tarjeta,
        nc = nc,
        aut = aut,
        aid = aid,
        arc = arc,
        tipo_pago = tipo_pago,
        stringsAsFactors = FALSE
      )
    })
    
    do.call(rbind, productos)
  } else {
    NULL
  }

}

# Procesamos todos los tickets
lista_tickets <- lapply(tickets, function(ticket) {
    procesar_ticket(ticket)
 
})

# Combinamos todos los data frames y filtramos los nulos
tickets_df <- de.call(rbind, lista_tickets[!sapply(lista_tickets, is.null)])

```

